name: Lightweight Keeper Build (Minimal Memory)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g. v25.12.16)'
        required: false
        default: ''

jobs:
  build-lightweight:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
      
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Create minimal keeper JAR
        run: |
          mkdir -p target/classes/com/github/vevc
          # ç¼–è¯‘ Keeper ç±»
          javac -d target/classes src/main/java/com/github/vevc/Keeper.java
          # åˆ›å»º MANIFEST
          mkdir -p target/META-INF
          echo "Main-Class: com.github.vevc.Keeper" > target/META-INF/MANIFEST.MF
          # æ‰“åŒ…æˆ JAR
          cd target/classes
          jar cfm ../java-keeper-minimal.jar ../META-INF/MANIFEST.MF .
          cd ../..
      
      - name: Set version tag
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=v$(date +'%y.%m.%d')-lightweight" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: "${{ steps.version.outputs.version }} - Lightweight Keeper"
          body: |
            ğŸª¶ è½»é‡çº§ Java Keeperï¼ˆé€‚åˆ 64MB å°å†…å­˜ VPSï¼‰
            
            ğŸ“¦ æ–‡ä»¶å¤§å°ï¼šçº¦ 2KB
            ğŸ’¾ è¿è¡Œå†…å­˜ï¼š16-32MBï¼ˆä½¿ç”¨ -Xmx32m å‚æ•°ï¼‰
            
            ğŸš€ è¿è¡Œå‘½ä»¤ï¼š
            ```
            java -Xms16m -Xmx32m -XX:MaxMetaspaceSize=32m -XX:+UseSerialGC \
                 -jar java-keeper-minimal.jar
            ```
            
            âœ¨ åŠŸèƒ½ï¼šä¿æŒ JVM è¿›ç¨‹å¸¸é©»ï¼Œå®šæœŸå¿ƒè·³è¾“å‡º
          files: target/java-keeper-minimal.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
